<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Chat</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 2em;
            background: #f2f2f2;
        }
        h2 { margin-top: 1em; }

        input, button {
            padding: 0.5em;
            margin: 0.3em;
            font-size: 1em;
        }

        #chat {
            border: 1px solid #ccc;
            background: white;
            height: 300px;
            overflow-y: auto;
            padding: 1em;
            margin-top: 1em;
        }

        .message {
            margin: 0.5em 0;
        }

        .me {
            text-align: right;
            color: blue;
        }

        .other {
            text-align: left;
            color: green;
        }

        #users {
            margin: 1em 0;
        }

        #status {
            color: green;
        }

        #login-status {
            color: blue;
        }
    </style>
</head>
<body>

<h2>Login / Register</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
<div id="login-status"></div>

<h2>Users</h2>
<input id="recipient" placeholder="Recipient ID">
<button onclick="connect()">Connect to Chat</button>
<div id="status"></div>

<h2>Chat</h2>
<div id="chat"></div>

<input id="msg" placeholder="Type a message">
<button onclick="send()">Send</button>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const authServiceUrl = "http://localhost:8080";
    const chatServiceUrl = "http://localhost:9090";

    let token = "";
    let userId = "";
    let stompClient = null;
    let currentRecipient = "";

    async function register() {
        const res = await fetch(`${authServiceUrl}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            })
        });

        const text = await res.text();
        alert(text);
    }

    async function login() {
        const res = await fetch(`${authServiceUrl}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            })
        });

        const data = await res.json();
        token = data.token;

        const valRes = await fetch(`${authServiceUrl}/auth/validate`, {
            headers: { "Authorization": "Bearer " + token }
        });
        const valData = await valRes.json();
        userId = valData.userId;

        document.getElementById("login-status").innerText = `Logged in as: ${userId}`;
    }

    function connect() {
        currentRecipient = document.getElementById("recipient").value;

        const socket = new SockJS(`${chatServiceUrl}/ws?token=${token}`);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, async () => {
            document.getElementById("status").innerText = "Connected";

            stompClient.subscribe(`/user/${userId}/queue/messages`, (msg) => {
                const body = JSON.parse(msg.body);
                appendMessage(`From ${body.senderId}`, body.senderId !== userId ? "other" : "me");
            });

            loadHistory();
        });
    }

    function send() {
        const content = document.getElementById("msg").value;
        if (!stompClient || !stompClient.connected) {
            alert("Not connected to WebSocket");
            return;
        }

        stompClient.send("/app/chat", {}, JSON.stringify({
            senderId: userId,
            recipientId: currentRecipient,
            content: content
        }));

        appendMessage(`You: ${content}`, "me");
        document.getElementById("msg").value = "";
    }

    function appendMessage(text, cls) {
        const chat = document.getElementById("chat");
        const div = document.createElement("div");
        div.className = `message ${cls}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function loadHistory() {
        const res = await fetch(`${chatServiceUrl}/messages/${userId}/${currentRecipient}`, {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        const messages = await res.json();
        const chat = document.getElementById("chat");
        chat.innerHTML = "";

        messages.forEach(msg => {
            appendMessage(`${msg.senderId === userId ? "You" : msg.senderId}: ${msg.content}`, msg.senderId === userId ? "me" : "other");
        });
    }
</script>

</body>
</html>
